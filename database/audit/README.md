# Database audit tools

Scripts for auditing database schema and verifying ERD documentation accuracy.

## Overview

These tools work with database audit JSON files (generated by the Lambda audit function) to:
1. Generate accurate ERD documentation from the actual database state
2. Verify that existing ERD documentation matches the database

## Scripts

### `generate_erd_from_audit.py`

Generates ERD markdown documentation from a database audit JSON file.

```bash
# Usage
python generate_erd_from_audit.py <audit_json_path> <output_md_path>

# Example
python generate_erd_from_audit.py ../../audits/Oct22.json ../schema/GENERATED_ERD.md
```

**Features:**
- Organizes tables into logical categories (Versioning, Lookup, Network, Entities, etc.)
- Documents column names, types, and nullability
- Identifies uncategorized tables that may need classification
- Reports record counts and audit field presence

### `verify_erd_against_audit.py`

Compares ERD documentation against actual database schema to identify discrepancies.

```bash
# Usage
python verify_erd_against_audit.py <erd_md_path> <audit_json_path>

# Example
python verify_erd_against_audit.py ../schema/COEQWAL_SCENARIOS_DB_ERD.md ../../audits/Oct22.json

# JSON output for CI/CD integration
python verify_erd_against_audit.py ../schema/ERD.md ../../audits/latest.json --json
```

**Features:**
- Identifies tables missing from ERD documentation
- Identifies tables in ERD that don't exist in database
- Reports column mismatches (missing/extra columns)
- Returns exit code 1 if ERD is out of sync (useful for CI/CD)

## Workflow

### Regular Audit Schedule

1. **Weekly**: Run verification to check ERD is up-to-date
   ```bash
   python verify_erd_against_audit.py ../schema/COEQWAL_SCENARIOS_DB_ERD.md ../../audits/latest.json
   ```

2. **After schema changes**: Regenerate ERD
   ```bash
   python generate_erd_from_audit.py ../../audits/latest.json ../schema/GENERATED_ERD.md
   # Review and merge into main ERD documentation
   ```

3. **Monthly**: Full audit review
   - Verify all tables are properly categorized
   - Check for orphaned records
   - Run data integrity validation

## Audit JSON Format

The audit JSON files are generated by the Lambda audit function and contain:

```json
{
  "audit_timestamp": "2025-10-22T17:02:10.221311",
  "database_info": {
    "database_name": "coeqwal_scenario",
    "postgresql_version": "PostgreSQL 17.4 ..."
  },
  "tables": [
    {
      "table": "table_name",
      "record_count": 100,
      "column_count": 10,
      "columns": [
        {
          "column_name": "id",
          "data_type": "integer",
          "is_nullable": false
        }
      ],
      "audit_fields": {
        "has_created_at": true,
        "has_updated_at": true,
        "has_created_by": true,
        "has_updated_by": true
      },
      "has_indexes": true
    }
  ]
}
```

## Adding New Table Categories

Edit `TABLE_CATEGORIES` in `generate_erd_from_audit.py` to add new logical groupings:

```python
TABLE_CATEGORIES = {
    'Versioning': ['version_family', 'version', ...],
    'New Category': ['new_table_1', 'new_table_2'],
    ...
}
```

## Related Resources

- Main database documentation: `../README.md`
- Schema documentation: `../schema/`
- SQL validation scripts: `../scripts/sql/validate_data_integrity.sql`
- Lambda audit function: Located in AWS Lambda
