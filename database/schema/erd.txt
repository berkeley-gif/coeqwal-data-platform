Table version_family {
  id          int   [pk, increment]
  short_code  text  [not null, unique]
  label       text
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (is_active, short_code)
  }
}
Ref: version_family.created_by > developer.id [delete: restrict, update: cascade]
Ref: version_family.updated_by > developer.id [delete: restrict, update: cascade]

Table domain_family_map {
  schema_name       text [not null]
  table_name        text [not null]
  version_family_id int  [not null]
  note              text
  Indexes {
    (schema_name, table_name) [pk]
  }
}
Ref: domain_family_map.version_family_id > version_family.id [delete: restrict, update: cascade]

Table version {
  id                int       [pk, increment]
  version_family_id int       [not null]
  version_number    text
  manifest          jsonb
  changelog         text
  is_active         boolean   [not null, default: false]
  created_at        timestamptz [not null, default: `now()`]
  created_by        int      [not null]
  updated_at        timestamptz [not null, default: `now()`]
  updated_by        int      [not null]
  Indexes {
    (version_family_id, version_number) [unique]
    (manifest)
    (version_family_id)
  }
}
Ref: version.version_family_id > version_family.id [delete: restrict, update: cascade]
Ref: version.created_by > developer.id [delete: restrict, update: cascade]
Ref: version.updated_by > developer.id [delete: restrict, update: cascade]

Table developer {
  id           int       [pk, increment]
  email        text      [unique]
  name         text
  display_name text      [not null]
  affiliation  text
  role         text
  aws_sso_user_id  text  [unique]
  aws_sso_username text  [unique]
  is_bootstrap boolean   [not null, default: false]
  sync_source  text      [default: 'manual']
  is_active    boolean   [not null, default: true]
  last_login   timestamptz
  created_at   timestamptz [not null, default: `now()`]
  updated_at   timestamptz [not null, default: `now()`]
  Indexes {
    (email) [unique]
    (aws_sso_user_id) [unique]
    (aws_sso_username) [unique]
    (role, is_active)
    (is_bootstrap, is_active)
    (sync_source, is_active)
  }
}

Table source {
  id          int     [pk, increment]
  source      text    [not null, unique]
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (source) [unique]
    (is_active, source)
  }
}
Ref: source.created_by > developer.id [delete: restrict, update: cascade]
Ref: source.updated_by > developer.id [delete: restrict, update: cascade]

Table calsim_schematic_type {
  id int [pk, increment]
  label text [not null, unique]
}

Table calsim_entity_type {
  id                int   [pk, increment]
  type              text  [not null, unique]
  schematic_type_id int
  description       text
  key_dynamic       text
  is_active         boolean [default: true]
  Indexes {
    (is_active, type)
  }
}

// NORMALIZED NETWORK ARCHITECTURE
// Separates connectivity from detailed node/arc attributes for better normalization
// Avoids sparse tables with many NULL columns for arc-only or node-only attributes

// Core connectivity and shared attributes
Table network_topology {
  id integer [pk, increment]
  short_code varchar [not null, unique, note: "Primary identifier from geopackage Arc_ID/CalSim_ID"]
  schematic_type varchar [not null, note: "node or arc"]
  
  // Note: Connectivity handled via foreign keys in network_arc table
  
  // Shared attributes
  name varchar [note: "Element name from geopackage"]
  calsim_id varchar [note: "CalSim system ID from geopackage"]
  type varchar [note: "Element type from geopackage Type field"]
  sub_type varchar [note: "Element subtype from geopackage Sub_Type field"]
  hydrologic_region_id integer [note: "FK to hydrologic_region"]
  
  // Control and versioning
  is_active boolean [not null, default: true, note: "Controls network visualization"]
  connectivity_status varchar [not null, note: "connected or unconnected"]
  has_gis boolean [not null, default: true, note: "Has spatial representation"]
  network_version_id integer [not null, default: 1, note: "Version tracking"]
  data_source_id integer [not null, note: "FK to source table"]
  
  indexes {
    short_code [unique]
    (is_active, schematic_type) [note: "Active elements filtering"]
    (from_node, to_node) [note: "Connectivity traversal"]
    (is_active, from_node, to_node) [note: "Active network traversal optimization"]
    (type, schematic_type) [note: "Element type filtering"]
    (hydrologic_region_id)
    (connectivity_status)
  }
}

// Arc-specific attributes
Table network_arc {
  id integer [pk, increment]
  short_code text [not null, unique, note: "Links to network_topology.short_code"]
  calsim_id text [note: "CalSim system ID"]
  arc_id text [note: "Arc identifier"]
  arc_type_id integer [not null, note: "FK to network_arc_type"]
  
  // Arc-specific attributes
  name text [note: "Arc name from geopackage NAME"]
  description text
  type text [note: "Element type from geopackage Type (CH, D, etc.)"]
  sub_type text [note: "Element subtype from geopackage Sub_Type (ST, CNL, etc.)"]
  from_node_id integer [note: "FK to network_node (origin)"]
  to_node_id integer [note: "FK to network_node (destination)"]
  node_suffix_comment text
  hydrologic_region_id integer [note: "FK to hydrologic_region"]
  shape_length numeric [note: "Arc length in meters"]
  
  // Arc modeling attributes
  model_source_id integer [not null, note: "FK to model_source"]
  source_id integer [not null, note: "FK to source"]
  model_arc_id text
  diagram_id integer
  is_reversible boolean [not null, default: false]
  flow_capacity numeric
  parent_arc_id integer [note: "Self-referencing FK for hierarchical arcs"]
  integration_status_id integer [not null, default: 1]
  
  // Spatial and metadata
  geom geometry [note: "PostGIS LINESTRING/MULTILINESTRING geometry"]
  model_attributes jsonb [default: '{}']
  network_version_id integer [not null]
  
  // Audit fields
  created_at timestamptz [not null, default: `now()`]
  created_by integer [not null]
  updated_at timestamptz
  updated_by integer
  
  indexes {
    short_code [unique]
    (arc_type_id)
    (from_node, to_node)
    (hydrologic_region_id)
    (model_source_id)
    (parent_arc_id)
    (integration_status_id)
  }
}

// Node-specific attributes
Table network_node {
  id integer [pk, increment]
  short_code text [not null, unique, note: "Links to network_topology.short_code"]
  calsim_id text [note: "CalSim system ID"]
  node_type_id integer [note: "FK to network_node_type"]
  
  // Node-specific attributes
  name text [note: "Node name"]
  description text
  riv_mi numeric [note: "River mile"]
  riv_name text [note: "River name"]
  comment text [note: "Node comment"]
  c2vsim_gw text [note: "C2VSIM groundwater ID"]
  c2vsim_sw text [note: "C2VSIM surface water ID"]
  type text [note: "Element type"]
  sub_type text [note: "Element subtype"]
  nrest_gage text [note: "Nearest gage from geopackage Nrest_Gage"]
  strm_code text [note: "Stream code from geopackage Strm_Code"]
  rm_ii text [note: "River mile indicator from geopackage RM_II"]
  hydrologic_region_id integer [note: "FK to hydrologic_region"]
  
  // Coordinates
  latitude numeric
  longitude numeric
  
  // Node modeling attributes
  model_source_id integer [not null, note: "FK to model_source"]
  source_id integer [not null, note: "FK to source"]
  model_node_id text
  diagram_id integer
  parent_node_id integer [note: "Self-referencing FK for hierarchical nodes"]
  integration_status_id integer [not null, default: 1]
  
  // Spatial and metadata
  geom geometry [note: "PostGIS POINT geometry"]
  model_attributes jsonb [default: '{}']
  network_version_id integer [not null]
  json_id text
  
  // Audit fields
  created_at timestamptz [not null, default: `now()`]
  created_by integer [not null]
  updated_at timestamptz
  updated_by integer
  
  indexes {
    short_code [unique]
    (node_type_id)
    (hydrologic_region_id)
    (model_source_id)
    (parent_node_id)
    (integration_status_id)
    (riv_name, riv_mi)
  }
}

// Foreign key relationships for network tables
Ref: network_topology.hydrologic_region_id > hydrologic_region.id [delete: restrict, update: cascade]
Ref: network_topology.data_source_id > source.id [delete: restrict, update: cascade]
Ref: network_topology.network_version_id > version.id [delete: restrict, update: cascade]

Ref: network_arc.short_code > network_topology.short_code [delete: restrict, update: cascade]
Ref: network_arc.arc_type_id > network_arc_type.id [delete: restrict, update: cascade]
Ref: network_arc.from_node_id > network_node.id [delete: restrict, update: cascade]
Ref: network_arc.to_node_id > network_node.id [delete: restrict, update: cascade]
Ref: network_arc.hydrologic_region_id > hydrologic_region.id [delete: restrict, update: cascade]
Ref: network_arc.model_source_id > model_source.id [delete: restrict, update: cascade]
Ref: network_arc.source_id > source.id [delete: restrict, update: cascade]
Ref: network_arc.parent_arc_id > network_arc.id [delete: restrict, update: cascade]
Ref: network_arc.integration_status_id > network_integration_status.id [delete: restrict, update: cascade]
Ref: network_arc.network_version_id > version.id [delete: restrict, update: cascade]
Ref: network_arc.created_by > developer.id [delete: restrict, update: cascade]
Ref: network_arc.updated_by > developer.id [delete: restrict, update: cascade]

Ref: network_node.short_code > network_topology.short_code [delete: restrict, update: cascade]
Ref: network_node.node_type_id > network_node_type.id [delete: restrict, update: cascade]
Ref: network_node.hydrologic_region_id > hydrologic_region.id [delete: restrict, update: cascade]
Ref: network_node.model_source_id > model_source.id [delete: restrict, update: cascade]
Ref: network_node.source_id > source.id [delete: restrict, update: cascade]
Ref: network_node.parent_node_id > network_node.id [delete: restrict, update: cascade]
Ref: network_node.integration_status_id > network_integration_status.id [delete: restrict, update: cascade]
Ref: network_node.network_version_id > version.id [delete: restrict, update: cascade]
Ref: network_node.created_by > developer.id [delete: restrict, update: cascade]
Ref: network_node.updated_by > developer.id [delete: restrict, update: cascade]

// Supporting tables for network topology
Table network_topology_manual_reviews {
  id integer [pk, increment]
  network_topology_id integer
  review_type varchar
  reviewer varchar
  review_date timestamp
  decision varchar
  reasoning text
  status varchar
}

Ref: network_topology_manual_reviews.network_topology_id > network_topology.id

Table network_topology_relationships {
  id integer [pk, increment]
  parent_topology_id integer
  child_topology_id integer
  relationship_type varchar
  confidence_score float
  notes text
}

Ref: network_topology_relationships.parent_topology_id > network_topology.id
Ref: network_topology_relationships.child_topology_id > network_topology.id

// Spatial data
Table network_gis {
  id integer [pk, increment]
  short_code varchar [not null, note: "Links to network_topology.short_code"]
  geometry_type varchar [not null, note: "point, linestring, multilinestring, polygon, multipolygon"]
  
  // PostGIS spatial data
  geom geometry [not null, note: "PostGIS geometry column with spatial index"]
  geom_wkt text [not null, note: "WKT representation from geopackage source"]
  srid integer [not null, default: 4326, note: "Spatial Reference System ID"]
  
  // Source and version tracking
  source_id integer [not null, note: "FK to source table - geopackage"]
  model_source_id integer [not null, note: "FK to model_source table - calsim3"]
  source_record_id varchar [note: "Original record ID from geopackage"]
  network_version_id integer [not null, default: 1, note: "Version tracking"]
  data_quality_score numeric [default: 1.0, note: "0.00 to 1.00 - geopackage is high quality"]
  
  // Entity relationships
  entity_type varchar [not null, note: "arc or node"]
  is_primary boolean [not null, default: true, note: "Primary geometry for this short_code"]
  priority_order integer [not null, default: 1, note: "For multiple geometries per short_code"]
  
  // Metadata
  coordinate_precision varchar [default: "high", note: "high, medium, low"]
  validation_status varchar [not null, default: "validated", note: "validated, pending, flagged"]
  
  // Audit trail (operators populate)
  created_at timestamptz [default: `now()`]
  created_by integer [note: "FK to developer table"]
  updated_at timestamptz [default: `now()`]
  updated_by integer [note: "FK to developer table"]
  notes text [note: "Empty but available for future operational notes"]
  
  indexes {
    short_code [note: "Fast JOIN with network_topology"]
    geometry_type [note: "Point vs linestring filtering"]
    entity_type [note: "Arc vs node filtering"]
    source_id [note: "Source system filtering"]
    // CRITICAL SPATIAL INDEXES (PostGIS GIST) 
    geom [type: gist, note: "PRIMARY spatial index for map queries"]
    geom [type: gist, where: "geometry_type = 'point'", note: "Point-only spatial index for nodes"]
    geom [type: gist, where: "geometry_type IN ('linestring', 'multilinestring')", note: "Line-only spatial index for arcs"]
    // FAST API INDEXES
    (short_code, geometry_type, is_primary) [note: "Fast GIS lookups"]
  }
}

// Foreign key relationships for network_gis
Ref: network_gis.source_id > source.id [delete: restrict, update: cascade]
Ref: network_gis.model_source_id > model_source.id [delete: restrict, update: cascade]
Ref: network_gis.created_by > developer.id [delete: restrict, update: cascade]
Ref: network_gis.updated_by > developer.id [delete: restrict, update: cascade]

Ref: calsim_entity_type.schematic_type_id > calsim_schematic_type.id

Table hydrologic_region {
  id         int  [pk, increment]
  short_code text [not null, unique]
  label      text
  is_active  boolean [not null, default: true]
  created_at timestamptz [not null, default: `now()`]
  created_by int [not null]
  updated_at timestamptz [not null, default: `now()`]
  updated_by int [not null]
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
  }
}
Ref: hydrologic_region.created_by > developer.id [delete: restrict, update: cascade]
Ref: hydrologic_region.updated_by > developer.id [delete: restrict, update: cascade]
Table unit {
  id              int     [pk, increment]
  short_code      text    [not null, unique]
  full_name       text
  canonical_group text
  is_active       boolean [not null, default: true]
  created_at      timestamptz [not null, default: `now()`]
  created_by      int      [not null]
  updated_at      timestamptz [not null, default: `now()`]
  updated_by      int      [not null]
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
    (canonical_group)
  }
}
Ref: unit.created_by > developer.id [delete: restrict, update: cascade]
Ref: unit.updated_by > developer.id [delete: restrict, update: cascade]

Table flow_regime {
  id         int   [pk, increment]
  short_code text  [not null, unique]
  description text
}

Table season {
  id          int   [pk, increment]
  label       text  [not null, unique]
  start_month int
  end_month   int
  notes       text
}

Table region {
  id           int   [pk, increment]
  primary_name text  [not null, unique]
  type         text
  alias_names  text[]
  geom         geometry
}

Table hydroclimate_variable_type {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  unit_id     int
  unit_hint   text
  description text
  is_active   boolean [default: true]
  Indexes {
    (is_active, short_code)
  }
}
Ref: hydroclimate_variable_type.unit_id > unit.id [delete: restrict, update: cascade]

Table variable_type {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  label       text [not null]
  description text
  is_active   boolean [default: true]
  Indexes {
    (is_active, short_code)
  }
}

Table analysis_type {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  label       text
  description text
  is_active   boolean [default: true]
  Indexes {
    (is_active, short_code)
  }
}

Table geometry_type {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  label       text
  description text
  is_active   boolean [default: true]
  Indexes {
    (is_active, short_code)
  }
}

Table statistic_type {
  id            int    [pk, increment]
  code          text   [not null, unique]
  name          text   [not null]
  description   text
  is_percentile boolean [not null, default: false]
  created_at    timestamptz [not null, default: `now()`]
  created_by    int      [not null]
  updated_at    timestamptz [not null, default: `now()`]
  updated_by    int      [not null]
  Indexes {
    (code) [unique]
  }
}
Ref: statistic_type.created_by > developer.id  [delete: restrict, update: cascade]
Ref: statistic_type.updated_by > developer.id  [delete: restrict, update: cascade]

Table theme {
  id                   int       [pk, increment]
  short_code           text      [not null]
  is_active            boolean   [not null, default: false]
  title                text      [not null]
  subtitle             text
  short_title          text
  simple_description   text
  description          text
  description_next     text
  narrative            jsonb
  outcome_description  text
  outcome_narrative    text
  source               text
  theme_version_id     int       [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int      [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int      [not null]
  Indexes {
    (short_code, is_active)
    (is_active)
  }
}
Ref: theme.theme_version_id > version.id [delete: restrict, update: cascade]
Ref: theme.created_by > developer.id [delete: restrict, update: cascade]
Ref: theme.updated_by > developer.id [delete: restrict, update: cascade]

Table scenario {
  id                   int      [pk, increment]
  short_code           text      [not null]
  is_active            boolean   [not null, default: false]
  title                text      [not null]
  subtitle             text
  short_title          text
  simple_description   text
  description          text
  narrative            jsonb
  baseline_scenario_id int
  hydroclimate_id      int
  scenario_author_id   int
  scenario_version_id  int       [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int      [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int      [not null]
  Indexes {
    (short_code, is_active)
    (is_active)
    (baseline_scenario_id)
    (hydroclimate_id)
    (is_active, scenario_version_id)
    (narrative)
    (title, description)
  }
}
Ref: scenario.baseline_scenario_id > scenario.id [delete: set null, update: cascade]
Ref: scenario.hydroclimate_id > hydroclimate.id [delete: restrict, update: cascade]
Ref: scenario.scenario_author_id > scenario_author.id [delete: restrict, update: cascade]
Ref: scenario.scenario_version_id > version.id [delete: restrict, update: cascade]
Ref: scenario.created_by > developer.id    [delete: restrict, update: cascade]
Ref: scenario.updated_by > developer.id    [delete: restrict, update: cascade]

Table theme_scenario_link {
  theme_id    int  [not null]
  scenario_id int  [not null]
  Indexes {
    (theme_id, scenario_id) [pk]
    (scenario_id, theme_id)
  }
}
Ref: theme_scenario_link.theme_id    > theme.id    [delete: restrict, update: cascade]
Ref: theme_scenario_link.scenario_id > scenario.id [delete: restrict, update: cascade]

Table theme_source {
  id            int   [pk, increment]
  short_code    text  [not null, unique]
  name          text  [not null]
  citation      text
  url           text
  doc_date      date
  notes         text
  created_at    timestamptz [not null, default: `now()`]
  created_by    int      [not null]
  updated_at    timestamptz [not null, default: `now()`]
  updated_by    int      [not null]
}
Ref: theme_source.created_by > developer.id [delete: restrict, update: cascade]
Ref: theme_source.updated_by > developer.id [delete: restrict, update: cascade]

Table theme_source_link {
  theme_id        int  [not null]
  theme_source_id int  [not null]
  Indexes {
    (theme_id, theme_source_id) [pk]
  }
}
Ref: theme_source_link.theme_id > theme.id [delete: restrict, update: cascade]
Ref: theme_source_link.theme_source_id > theme_source.id [delete: restrict, update: cascade]

Table scenario_author {
  id            int   [pk, increment]
  short_code    text  [not null, unique]
  name          text  [not null]
  email         text
  organization  text
  affiliation   text
  is_active     boolean [not null, default: true]
  created_at    timestamptz [not null, default: `now()`]
  created_by    int      [not null]
  updated_at    timestamptz [not null, default: `now()`]
  updated_by    int      [not null]
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
  }
}
Ref: scenario_author.created_by > developer.id [delete: restrict, update: cascade]
Ref: scenario_author.updated_by > developer.id [delete: restrict, update: cascade]

Table scenario_source {
  id            int   [pk, increment]
  short_code    text  [not null, unique]
  name          text  [not null]
  citation      text
  url           text
  doc_date      date
  notes         text
  created_at    timestamptz [not null, default: `now()`]
  created_by    int      [not null]
  updated_at    timestamptz [not null, default: `now()`]
  updated_by    int      [not null]
  Indexes {
    (short_code) [unique]
  }
}
Ref: scenario_source.created_by > developer.id [delete: restrict, update: cascade]
Ref: scenario_source.updated_by > developer.id [delete: restrict, update: cascade]

Table scenario_source_link {
  scenario_id        int [not null]
  scenario_source_id int [not null]
  Indexes {
    (scenario_id, scenario_source_id) [pk]
  }
}
Ref: scenario_source_link.scenario_id > scenario.id [delete: restrict, update: cascade]
Ref: scenario_source_link.scenario_source_id > scenario_source.id [delete: restrict, update: cascade]

Table assumption_category {
  id          int    [pk, increment]
  short_code  text   [not null, unique]
  label       text   [not null]
  description text
  is_active   boolean   [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (is_active, short_code)
  }
}
Ref: assumption_category.created_by > developer.id [delete: restrict, update: cascade]
Ref: assumption_category.updated_by > developer.id [delete: restrict, update: cascade]

Table assumption_definition {
  id                     int   [pk, increment]
  short_code             text  [not null]
  title                  text  [not null]
  category_id            int   [not null]
  description            text
  source                 text
  source_access_date     date
  file                   text
  assumptions_version_id int   [not null]
  is_active              boolean   [not null, default: true]
  notes                  text
  created_at             timestamptz [not null, default: `now()`]
  created_by             int      [not null]
  updated_at             timestamptz [not null, default: `now()`]
  updated_by             int      [not null]
  Indexes {
    (category_id, short_code)
    (is_active)
  }
}
Ref: assumption_definition.category_id > assumption_category.id [delete: restrict, update: cascade]
Ref: assumption_definition.assumptions_version_id > version.id [delete: restrict, update: cascade]
Ref: assumption_definition.created_by > developer.id [delete: restrict, update: cascade]
Ref: assumption_definition.updated_by > developer.id [delete: restrict, update: cascade]

Table assumption_param_TUCP_TUCO {
  id            int  [pk, increment]
  assumption_id int  [not null]
  region_id     int
  season_id     int
  detail        jsonb
  Indexes {
    (assumption_id)
  }
}
Ref: assumption_param_TUCP_TUCO.assumption_id > assumption_definition.id [delete: cascade, update: restrict]
Ref: assumption_param_TUCP_TUCO.region_id > region.id [delete: restrict, update: cascade]
Ref: assumption_param_TUCP_TUCO.season_id > season.id [delete: restrict, update: cascade]

Table assumption_param_land_use {
  id            int  [pk, increment]
  assumption_id int  [not null]
  crop          text
  amount        numeric
  unit_id       int
  region_id     int
  season_id     int
  detail        jsonb
  Indexes {
    (assumption_id, crop) [unique]
  }
}
Ref: assumption_param_land_use.assumption_id > assumption_definition.id [delete: cascade, update: restrict]
Ref: assumption_param_land_use.unit_id > unit.id [delete: restrict, update: cascade]
Ref: assumption_param_land_use.season_id > season.id [delete: restrict, update: cascade]

Table assumption_param_SGMA {
  id            int  [pk, increment]
  assumption_id int  [not null]
  region_id     int
  amount        numeric
  unit_id       int
  detail        jsonb
  Indexes {
    (assumption_id, region_id) [unique]
  }
}
Ref: assumption_param_SGMA.assumption_id > assumption_definition.id [delete: cascade, update: restrict]
Ref: assumption_param_SGMA.region_id > region.id [delete: restrict, update: cascade]
Ref: assumption_param_SGMA.unit_id > unit.id [delete: restrict, update: cascade]

Table assumption_param_slr {
  id              int  [pk, increment]
  assumption_id   int  [not null]
  projection_year int
  slr             numeric
  unit_id         int
  detail          jsonb
  Indexes {
    (assumption_id, slr, unit_id) [unique]
  }
}
Ref: assumption_param_slr.assumption_id > assumption_definition.id [delete: cascade, update: restrict]
Ref: assumption_param_slr.unit_id > unit.id [delete: restrict, update: cascade]

Table assumption_param_gwmodel {
  id            int  [pk, increment]
  assumption_id int  [not null]
  detail        jsonb
  Indexes {
    (assumption_id)
  }
}
Ref: assumption_param_gwmodel.assumption_id > assumption_definition.id [delete: cascade, update: restrict]

Table assumption_param_bioops {
  id            int  [pk, increment]
  assumption_id int  [not null]
  detail        jsonb
  Indexes {
    (assumption_id)
  }
}
Ref: assumption_param_bioops.assumption_id > assumption_definition.id [delete: cascade, update: restrict]

Table assumption_param_kv {
  id            int  [pk, increment]
  assumption_id int  [not null]
  key           text [not null]
  value_num     numeric
  value_txt     text
  unit_id       int
  region_id     int
  season_id     int
  detail        jsonb
  Indexes {
    (assumption_id, key) [unique]
  }
}
Ref: assumption_param_kv.assumption_id > assumption_definition.id [delete: cascade, update: restrict]
Ref: assumption_param_kv.unit_id > unit.id [delete: restrict, update: cascade]
Ref: assumption_param_kv.region_id > region.id [delete: restrict, update: cascade]
Ref: assumption_param_kv.season_id > season.id [delete: restrict, update: cascade]

Table theme_key_assumption_link {
  theme_id                 int  [not null]
  assumption_definition_id int  [not null]
  Indexes {
    (theme_id, assumption_definition_id) [pk]
    (assumption_definition_id, theme_id)
  }
}
Ref: theme_key_assumption_link.theme_id                 > theme.id                 [delete: restrict, update: cascade]
Ref: theme_key_assumption_link.assumption_definition_id > assumption_definition.id [delete: restrict, update: cascade]

Table scenario_key_assumption_link {
  scenario_id   int [not null]
  assumption_id int [not null]
  Indexes {
    (scenario_id, assumption_id) [pk]
    (assumption_id, scenario_id)
  }
}
Ref: scenario_key_assumption_link.scenario_id  > scenario.id            [delete: restrict, update: cascade]
Ref: scenario_key_assumption_link.assumption_id > assumption_definition.id [delete: restrict, update: cascade]

Table operation_category {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  name        text
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (is_active, short_code)
  }
}
Ref: operation_category.created_by > developer.id [delete: restrict, update: cascade]
Ref: operation_category.updated_by > developer.id [delete: restrict, update: cascade]

Table operation_definition {
  id                   int   [pk, increment]
  short_code           text  [not null]
  name                 text  [not null]
  category_id          int   [not null]
  description          text
  is_active            boolean   [not null, default: true]
  notes                text
  operation_version_id int   [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int      [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int      [not null]
  Indexes {
    (is_active)
    (category_id, short_code)
  }
}
Ref: operation_definition.operation_version_id > version.id [delete: restrict, update: cascade]
Ref: operation_definition.category_id > operation_category.id [delete: restrict, update: cascade]
Ref: operation_definition.created_by          > developer.id    [delete: restrict, update: cascade]
Ref: operation_definition.updated_by          > developer.id    [delete: restrict, update: cascade]

Table operation_param_priority_allocation {
  id              int    [pk, increment]
  operation_id    int    [not null]
  allocation_type text
  region_id       int
  season_id       int
  detail          jsonb
  Indexes {
    (operation_id)
  }
}
Ref: operation_param_priority_allocation.operation_id  > operation_definition.id [delete: cascade, update: restrict]
Ref: operation_param_priority_allocation.region_id > region.id [delete: restrict, update: cascade]
Ref: operation_param_priority_allocation.season_id > season.id [delete: restrict, update: cascade]

Table operation_param_minimum_flow {
  id                int    [pk, increment]
  operation_id      int    [not null]
  tributary         text
  region_id         int
  season_id         int
  flow_regime_id    int
  flow_target_value numeric
  unit_id           int
  detail            jsonb
  Indexes {
    (operation_id)
    (operation_id, tributary) [unique]
  }
}
Ref: operation_param_minimum_flow.operation_id  > operation_definition.id [delete: cascade, update: restrict]
Ref: operation_param_minimum_flow.region_id > region.id [delete: restrict, update: cascade]
Ref: operation_param_minimum_flow.season_id > season.id [delete: restrict, update: cascade]
Ref: operation_param_minimum_flow.flow_regime_id > flow_regime.id [delete: restrict, update: cascade]
Ref: operation_param_minimum_flow.unit_id > unit.id [delete: restrict, update: cascade]

Table operation_param_infrastructure {
  id                  int    [pk, increment]
  operation_id        int    [not null]
  infrastructure_name text
  operation_level     text
  unit_id             int
  detail              jsonb
  Indexes {
    (operation_id)
    (operation_id, infrastructure_name) [unique]
  }
}
Ref: operation_param_infrastructure.operation_id  > operation_definition.id [delete: cascade, update: restrict]
Ref: operation_param_infrastructure.unit_id > unit.id [delete: restrict, update: cascade]

Table operation_param_regulatory {
  id               int    [pk, increment]
  operation_id     int    [not null]
  regulation_type  int
  regulation_name  text
  detail           jsonb
  Indexes {
    (operation_id)
    (operation_id, regulation_type, regulation_name) [unique]
  }
}
Ref: operation_param_regulatory.operation_id  > operation_definition.id [delete: cascade, update: restrict]

Table operation_param_carryover {
  id            int    [pk, increment]
  operation_id  int    [not null]
  reservoir_id  int
  amount        numeric
  unit_id       int
  detail        jsonb
  Indexes {
    (operation_id)
    (operation_id, reservoir_id, amount) [unique]
  }
}
Ref: operation_param_carryover.operation_id  > operation_definition.id [delete: cascade, update: restrict]
Ref: operation_param_carryover.reservoir_id  > reservoir_entity.id [delete: cascade, update: restrict]
Ref: operation_param_carryover.unit_id > unit.id [delete: restrict, update: cascade]

Table operation_param_kv {
  id            int    [pk, increment]
  operation_id  int    [not null]
  key           text   [not null]
  value_num     numeric
  value_txt     text
  unit_id       int
  region_id     int
  season_id     int
  detail        jsonb
  Indexes {
    (operation_id, key) [unique]
  }
}
Ref: operation_param_kv.operation_id  > operation_definition.id [delete: cascade, update: restrict]
Ref: operation_param_kv.unit_id > unit.id [delete: restrict, update: cascade]
Ref: operation_param_kv.region_id > region.id [delete: restrict, update: cascade]
Ref: operation_param_kv.season_id > season.id [delete: restrict, update: cascade]

Table theme_key_operation_link {
  theme_id     int [not null]
  operation_id int [not null]
  Indexes {
    (theme_id, operation_id) [pk]
    (operation_id, theme_id)
  }
}
Ref: theme_key_operation_link.theme_id     > theme.id                [delete: restrict, update: cascade]
Ref: theme_key_operation_link.operation_id > operation_definition.id [delete: restrict, update: cascade]

Table scenario_key_operation_link {
  scenario_id  int [not null]
  operation_id int [not null]
  Indexes {
    (scenario_id, operation_id) [pk]
    (operation_id, scenario_id)
  }
}
Ref: scenario_key_operation_link.scenario_id  > scenario.id           [delete: restrict, update: cascade]
Ref: scenario_key_operation_link.operation_id > operation_definition.id [delete: restrict, update: cascade]

Table outcome_category {
  id                 int  [pk, increment]
  short_code         text [not null, unique]
  label              text
  description        text
  outcome_version_id int  [not null]
  is_active          boolean [default: true]
  created_at         timestamptz [not null, default: `now()`]
  created_by         int      [not null]
  updated_at         timestamptz [not null, default: `now()`]
  updated_by         int      [not null]
  Indexes {
    (is_active, short_code)
  }
}
Ref: outcome_category.outcome_version_id > version.id           [delete: restrict, update: cascade]
Ref: outcome_category.created_by         > developer.id      [delete: restrict, update: cascade]
Ref: outcome_category.updated_by         > developer.id      [delete: restrict, update: cascade]

Table outcome_measure {
  id                  int  [pk, increment]
  outcome_category_id int  [not null]
  short_code          text [not null]
  name                text [not null]
  description         text
  unit_id             int
  temporal_scale_id   int
  spatial_scale_id    int
  calc_note           text
  metrics_version_id  int [not null]
  is_active           boolean [default: true]
  created_at          timestamptz [not null, default: `now()`]
  created_by          int      [not null]
  updated_at          timestamptz [not null, default: `now()`]
  updated_by          int      [not null]
  Indexes {
    (outcome_category_id, short_code)
    (is_active)
  }
}
Ref: outcome_measure.outcome_category_id  > outcome_category.id [delete: restrict, update: cascade]
Ref: outcome_measure.unit_id              > unit.id             [delete: restrict, update: cascade]
Ref: outcome_measure.temporal_scale_id    > temporal_scale.id   [delete: restrict, update: cascade]
Ref: outcome_measure.spatial_scale_id     > spatial_scale.id    [delete: restrict, update: cascade]
Ref: outcome_measure.metrics_version_id   > version.id          [delete: restrict, update: cascade]
Ref: outcome_measure.created_by           > developer.id        [delete: restrict, update: cascade]
Ref: outcome_measure.updated_by           > developer.id        [delete: restrict, update: cascade]

Table measure_variable_link {
  measure_id  int  [not null]
  variable_id uuid [not null]
  Indexes {
    (measure_id, variable_id) [pk]
    (variable_id, measure_id)
  }
}
Ref: measure_variable_link.measure_id  > outcome_measure.id  [delete: restrict, update: cascade]
Ref: measure_variable_link.variable_id > variable.id        [delete: restrict, update: cascade]

Table temporal_scale {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  label       text [not null]
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
  }
}
Ref: temporal_scale.created_by > developer.id [delete: restrict, update: cascade]
Ref: temporal_scale.updated_by > developer.id [delete: restrict, update: cascade]

Table spatial_scale {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  label       text
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
  }
}
Ref: spatial_scale.created_by > developer.id [delete: restrict, update: cascade]
Ref: spatial_scale.updated_by > developer.id [delete: restrict, update: cascade]

Table scenario_variable_statistic {
  scenario_id        int  [not null]
  variable_id        uuid [not null]
  statistic_type_id  int  [not null]
  value              numeric [not null]
  source_version_id  int    [not null]
  created_at         timestamptz [not null, default: `now()`]
  created_by         int
  updated_at         timestamptz
  updated_by         int
  Indexes {
    (scenario_id, variable_id, statistic_type_id) [pk]
    (variable_id, statistic_type_id)
    (scenario_id, variable_id)
    (variable_id, scenario_id)
  }
}
Ref: scenario_variable_statistic.source_version_id > version.id
Ref: scenario_variable_statistic.scenario_id > scenario.id
Ref: scenario_variable_statistic.statistic_type_id > statistic_type.id
Ref: scenario_variable_statistic.created_by > developer.id
Ref: scenario_variable_statistic.updated_by > developer.id

Table scenario_measure_statistic {
  scenario_id        int [not null]
  measure_id         int  [not null]
  statistic_type_id  int  [not null]
  value              numeric [not null]
  source_version_id  int    [not null]
  created_at         timestamptz [not null, default: `now()`]
  created_by         int
  updated_at         timestamptz
  updated_by         int
  Indexes {
    (scenario_id, measure_id, statistic_type_id) [pk]
    (measure_id, statistic_type_id)
    (measure_id, scenario_id)
  }
}
Ref: scenario_measure_statistic.measure_id > outcome_measure.id
Ref: scenario_measure_statistic.source_version_id > version.id
Ref: scenario_measure_statistic.scenario_id > scenario.id
Ref: scenario_measure_statistic.statistic_type_id > statistic_type.id
Ref: scenario_measure_statistic.created_by > developer.id
Ref: scenario_measure_statistic.updated_by > developer.id

Table scenario_outcome_statistic {
  scenario_id       int [not null]
  outcome_id        int  [not null]
  statistic_type_id int  [not null]
  value             numeric [not null]
  source_version_id int [not null]
  created_at        timestamptz [not null, default: `now()`]
  created_by        int
  updated_at        timestamptz
  updated_by        int
  Indexes {
    (scenario_id, outcome_id, statistic_type_id) [pk]
    (outcome_id, statistic_type_id)
  }
}
Ref: scenario_outcome_statistic.source_version_id > version.id
Ref: scenario_outcome_statistic.scenario_id > scenario.id
Ref: scenario_outcome_statistic.outcome_id > outcome_measure.id
Ref: scenario_outcome_statistic.statistic_type_id > statistic_type.id
Ref: scenario_outcome_statistic.created_by > developer.id
Ref: scenario_outcome_statistic.updated_by > developer.id

Table scenario_category_statistic {
  scenario_id       int  [not null, ref: > scenario.id]
  category_id       int  [not null, ref: > outcome_category.id]
  statistic_type_id int  [not null, ref: > statistic_type.id]
  value             numeric [not null]
  source_version_id int  [not null, ref: > version.id]
  created_at        timestamptz [not null, default: `now()`]
  created_by        int
  updated_at        timestamptz
  updated_by        int
  Indexes {
    (scenario_id, category_id, statistic_type_id) [pk]
    (category_id, statistic_type_id)
  }
}

Table theme_outcome_priority {
  theme_id            int     [not null]
  outcome_category_id int     [not null]
  priority_rank       int     [not null]
  focus_weight        numeric [default: 1.0]
  research_rationale  text
  measurement_focus   text
  created_at          timestamptz [not null, default: `now()`]
  created_by          int      [not null]
  updated_at          timestamptz
  updated_by          int
  Indexes {
    (theme_id, priority_rank) [unique]
    (theme_id, outcome_category_id) [unique]
    (outcome_category_id, theme_id)
    (priority_rank)
  }
}
Ref: theme_outcome_priority.theme_id            > theme.id            [delete: cascade, update: cascade]
Ref: theme_outcome_priority.outcome_category_id > outcome_category.id [delete: restrict, update: cascade]
Ref: theme_outcome_priority.created_by          > developer.id
Ref: theme_outcome_priority.updated_by          > developer.id

Table theme_outcome_measure_focus {
  theme_id            int     [not null]
  outcome_measure_id  int     [not null]
  focus_level         text    [not null]
  analytical_emphasis text
  tier_relevance      boolean [default: false]
  created_at          timestamptz [not null, default: `now()`]
  created_by          int      [not null]
  Indexes {
    (theme_id, outcome_measure_id) [pk]
    (outcome_measure_id, theme_id)
    (focus_level)
    (tier_relevance)
  }
}
Ref: theme_outcome_measure_focus.theme_id           > theme.id         [delete: cascade, update: cascade]
Ref: theme_outcome_measure_focus.outcome_measure_id > outcome_measure.id [delete: restrict, update: cascade]
Ref: theme_outcome_measure_focus.created_by         > developer.id

Table hydroclimate_source {
  id          int       [pk, increment]
  short_code  text      [not null, unique]
  name        text
  description text
  citation    text
  url         text
  notes       text
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (short_code)
  }
}
Ref: hydroclimate_source.created_by > developer.id
Ref: hydroclimate_source.updated_by > developer.id

Table hydroclimate {
  id                      int       [pk, increment]
  short_code              text      [not null, unique]
  name                    text
  description             text
  is_active               boolean [not null, default: true]
  projection_year         int
  slr_value               numeric
  slr_unit_id             int
  source_id               int
  notes                   text
  hydroclimate_version_id int
  created_at              timestamptz [not null, default: `now()`]
  created_by              int      [not null]
  updated_at              timestamptz [not null, default: `now()`]
  updated_by              int      [not null]
  Indexes {
    (is_active, short_code)
    (source_id)
  }
}
Ref: hydroclimate.hydroclimate_version_id > version.id
Ref: hydroclimate.source_id              > hydroclimate_source.id
Ref: hydroclimate.slr_unit_id            > unit.id
Ref: hydroclimate.created_by             > developer.id
Ref: hydroclimate.updated_by             > developer.id

Table hydroclimate_variable_summary {
  id                  int       [pk, increment]
  hydroclimate_id     int       [not null]
  variable_type_id    int       [not null]
  unit_id             int
  description         text
  distribution_data   jsonb
  variable_version_id int       [not null]
  created_at          timestamptz [not null, default: `now()`]
  created_by          int      [not null]
  updated_at          timestamptz [not null, default: `now()`]
  updated_by          int      [not null]
  Indexes {
    (hydroclimate_id, variable_type_id) [unique]
  }
}
Ref: hydroclimate_variable_summary.variable_type_id > hydroclimate_variable_type.id
Ref: hydroclimate_variable_summary.hydroclimate_id > hydroclimate.id
Ref: hydroclimate_variable_summary.unit_id         > unit.id
Ref: hydroclimate_variable_summary.variable_version_id > version.id
Ref: hydroclimate_variable_summary.created_by      > developer.id
Ref: hydroclimate_variable_summary.updated_by      > developer.id

Table variable_group_type {
  id          int    [pk, increment]
  short_code  text   [not null, unique]
  name        text   [not null]
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz [not null, default: `now()`]
  updated_by  int      [not null]
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
  }
}
Ref: variable_group_type.created_by > developer.id
Ref: variable_group_type.updated_by > developer.id

Table variable_group {
  id                   int     [pk, increment]
  group_type_id        int     [not null]
  short_code           text    [not null]
  name                 text    [not null]
  description          text
  purpose              text
  selection_criteria   text
  is_active            boolean [not null, default: true]
  variable_version_id  int     [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int      [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int      [not null]
  Indexes {
    (group_type_id, short_code) [unique]
    (is_active, group_type_id)
  }
}
Ref: variable_group.group_type_id       > variable_group_type.id [delete: restrict, update: cascade]
Ref: variable_group.variable_version_id > version.id
Ref: variable_group.created_by          > developer.id
Ref: variable_group.updated_by          > developer.id

Table variable {
  id            uuid     [pk, default: `gen_random_uuid()`]
  kind          text     [not null]
  source_table  text     [not null]
  source_pk     int      [not null]
  created_at    timestamptz [not null, default: `now()`]
  created_by    int      [not null]
  Indexes {
    (source_table, source_pk) [unique]
    (kind)
  }
}
Ref: variable.created_by > developer.id

Table variable_source_link {
  variable_id uuid [not null]
  source_id   int  [not null]
  Indexes {
    (variable_id, source_id) [pk]
    (source_id, variable_id)
  }
}
Ref: variable_source_link.variable_id > variable.id [delete: cascade, update: cascade]
Ref: variable_source_link.source_id > source.id [delete: restrict, update: cascade]

Table variable_aggregation {
  parent_variable_id uuid [not null]
  child_variable_id  uuid [not null]
  relationship       text
  Indexes {
    (parent_variable_id, child_variable_id) [pk]
    (child_variable_id, parent_variable_id)
  }
}
Ref: variable_aggregation.parent_variable_id > variable.id [delete: cascade, update: cascade]
Ref: variable_aggregation.child_variable_id  > variable.id [delete: restrict, update: cascade]

Table tier_definition {
  id               int  [pk, increment]
  name             text [not null, unique]
  description      text
  rationale        text
  method           text
  outcome_measures text[]
  is_active        boolean   [not null, default: false]
  tier_version_id  int       [not null]
  created_at       timestamptz [not null, default: `now()`]
  created_by       int      [not null]
  updated_at       timestamptz [not null, default: `now()`]
  updated_by       int      [not null]
  Indexes {
    (is_active, name)
  }
}
Ref: tier_definition.tier_version_id > version.id
Ref: tier_definition.created_by  > developer.id
Ref: tier_definition.updated_by  > developer.id

Table tier_level {
  tier_id              int  [not null]
  level                int  [not null]
  label                text
  short_description    text
  detailed_description text
  tier_version_id      int  [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int      [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int      [not null]
  Indexes {
    (tier_id, level) [pk]
  }
}
Ref: tier_level.tier_id        > tier_definition.id         [delete: cascade,  update: cascade]
Ref: tier_level.tier_version_id> version.id
Ref: tier_level.created_by     > developer.id
Ref: tier_level.updated_by     > developer.id

Table tier_outcome_link {
  tier_id    int [not null]
  outcome_id int [not null]
  Indexes {
    (tier_id, outcome_id) [pk]
    (outcome_id, tier_id)
  }
}
Ref: tier_outcome_link.tier_id    > tier_definition.id
Ref: tier_outcome_link.outcome_id > outcome_measure.id

Table tier_variable_group_link {
  tier_id    int [not null]
  group_id   int [not null]
  created_at timestamptz [not null, default: `now()`]
  created_by int [not null]
  Indexes {
    (tier_id, group_id) [pk]
    (group_id, tier_id)
  }
}
Ref: tier_variable_group_link.tier_id    > tier_definition.id [delete: cascade, update: cascade]
Ref: tier_variable_group_link.group_id   > variable_group.id  [delete: cascade, update: cascade]
Ref: tier_variable_group_link.created_by > developer.id

Table scenario_metadata {
  id            uuid   [pk, default: `gen_random_uuid()`]
  scenario_id   int    [not null]
  theme_id      int    [not null]
  study_name    text
  alias         text
  version       text
  url           text
  created       date
  last_modified date
  raw           jsonb  [not null]
  created_at    timestamptz [not null, default: `now()`]
  created_by    int      [not null]
  updated_at    timestamptz [not null, default: `now()`]
  updated_by    int      [not null]
  Indexes {
    (scenario_id) [unique]
    (study_name)
    (alias)
    (theme_id, scenario_id)
  }
}
Ref: scenario_metadata.theme_id    > theme.id
Ref: scenario_metadata.scenario_id > scenario.id
Ref: scenario_metadata.created_by  > developer.id
Ref: scenario_metadata.updated_by  > developer.id

Table scenario_ancillary_output {
  id                   uuid [pk, default: `gen_random_uuid()`]
  scenario_metadata_id uuid [not null]
  output_type          text
  file_name            text
  metadata_version_id  int  [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int  [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int  [not null]
}
Ref: scenario_ancillary_output.scenario_metadata_id > scenario_metadata.id
Ref: scenario_ancillary_output.metadata_version_id  > version.id
Ref: scenario_ancillary_output.created_by           > developer.id
Ref: scenario_ancillary_output.updated_by           > developer.id

Table model_source {
  id                int   [pk, increment]
  short_code        text  [not null, unique]
  name              text  [unique, not null]
  version_family_id int   [not null]
  description       text
  contact           text
  notes             text
  created_at        timestamptz [not null, default: `now()`]
  created_by        int      [not null]
  updated_at        timestamptz [not null, default: `now()`]
  updated_by        int      [not null]
}
Ref: model_source.version_family_id > version_family.id
Ref: model_source.created_by        > developer.id
Ref: model_source.updated_by        > developer.id

Table model_variable {
  id                  int   [pk, increment]
  model_source_id     int   [not null]
  short_code          text  [not null]
  name                text
  unit_id             int
  temporal_scale_id   int   [not null]
  geometry_type_id    int
  description         text
  variable_version_id int   [not null]
  Indexes {
    (model_source_id, short_code) [unique]
  }
}
Ref: model_variable.model_source_id     > model_source.id
Ref: model_variable.variable_version_id > version.id
Ref: model_variable.unit_id > unit.id
Ref: model_variable.temporal_scale_id > temporal_scale.id
Ref: model_variable.geometry_type_id > geometry_type.id

Table model_run {
  id              uuid [pk, default: `gen_random_uuid()`]
  model_source_id int  [not null]
  scenario_id     int  [not null]
  run_timestamp   timestamptz [not null]
  manifest        jsonb
  notes           text
  created_at      timestamptz [not null, default: `now()`]
  created_by      int [not null]
  updated_at      timestamptz [not null, default: `now()`]
  updated_by      int [not null]
  Indexes {
    (model_source_id, scenario_id, run_timestamp) [unique]
  }
}
Ref: model_run.model_source_id > model_source.id
Ref: model_run.scenario_id     > scenario.id
Ref: model_run.created_by      > developer.id
Ref: model_run.updated_by      > developer.id

Table model_value {
  id                int     [pk, increment]
  model_run_id      uuid    [not null]
  variable_id       int     [not null]
  geometry_id       uuid
  value             numeric [not null]
  source_version_id int     [not null]
  created_at        timestamptz [not null, default: `now()`]
  created_by        int [not null]
  updated_at        timestamptz [not null, default: `now()`]
  updated_by        int [not null]
  Indexes {
    (model_run_id, variable_id, geometry_id) [unique]
    (variable_id, geometry_id)
    (geometry_id)
  }
}
Ref: model_value.model_run_id      > model_run.id
Ref: model_value.variable_id       > model_variable.id
Ref: model_value.geometry_id       > geometry.id
Ref: model_value.source_version_id > version.id
Ref: model_value.created_by        > developer.id
Ref: model_value.updated_by        > developer.id

Table analysis {
  id                      int  [pk, increment]
  name                    text [unique, not null]
  description             text
  analysis_type_id        int
  notes                   text
  interpretive_version_id int [not null]
  created_at              timestamptz [not null, default: `now()`]
  created_by              int      [not null]
  updated_at              timestamptz [not null, default: `now()`]
  updated_by              int      [not null]
}
Ref: analysis.analysis_type_id       > analysis_type.id
Ref: analysis.interpretive_version_id> version.id
Ref: analysis.created_by             > developer.id
Ref: analysis.updated_by             > developer.id

Table key_concept {
  id                      int  [pk, increment]
  name                    text [unique, not null]
  definition              text
  interpretive_version_id int  [not null]
  created_at              timestamptz [not null, default: `now()`]
  created_by              int      [not null]
  updated_at              timestamptz [not null, default: `now()`]
  updated_by              int      [not null]
}
Ref: key_concept.interpretive_version_id > version.id
Ref: key_concept.created_by              > developer.id
Ref: key_concept.updated_by              > developer.id

Table chart_type {
  id                      int  [pk, increment]
  type                    text [unique, not null]
  interpretive_version_id int  [not null]
  created_at              timestamptz [not null, default: `now()`]
  created_by              int      [not null]
  updated_at              timestamptz [not null, default: `now()`]
  updated_by              int      [not null]
}
Ref: chart_type.interpretive_version_id > version.id
Ref: chart_type.created_by              > developer.id
Ref: chart_type.updated_by              > developer.id

Table ancillary_data {
  id                       int  [pk, increment]
  name                     text [unique, not null]
  data                     json
  description              text
  source                   text
  interpretive_version_id  int  [not null]
  created_at               timestamptz [not null, default: `now()`]
  created_by               int      [not null]
  updated_at               timestamptz [not null, default: `now()`]
  updated_by               int      [not null]
}
Ref: ancillary_data.interpretive_version_id > version.id
Ref: ancillary_data.created_by              > developer.id
Ref: ancillary_data.updated_by              > developer.id

Table theme_key_concept_link {
  theme_id       int [not null]
  key_concept_id int [not null]
  Indexes {
    (theme_id, key_concept_id) [pk]
    (key_concept_id, theme_id)
  }
}
Ref: theme_key_concept_link.theme_id       > theme.id
Ref: theme_key_concept_link.key_concept_id > key_concept.id

Table theme_chart_type_link {
  theme_id      int [not null]
  chart_type_id int [not null]
  Indexes {
    (theme_id, chart_type_id) [pk]
    (chart_type_id, theme_id)
  }
}
Ref: theme_chart_type_link.theme_id     > theme.id
Ref: theme_chart_type_link.chart_type_id > chart_type.id

Table theme_ancillary_data_link {
  theme_id          int [not null]
  ancillary_data_id int [not null]
  Indexes {
    (theme_id, ancillary_data_id) [pk]
    (ancillary_data_id, theme_id)
  }
}
Ref: theme_ancillary_data_link.theme_id          > theme.id
Ref: theme_ancillary_data_link.ancillary_data_id > ancillary_data.id

Table theme_analysis_link {
  theme_id    int [not null]
  analysis_id int [not null]
  Indexes {
    (theme_id, analysis_id) [pk]
    (analysis_id, theme_id)
  }
}
Ref: theme_analysis_link.theme_id    > theme.id
Ref: theme_analysis_link.analysis_id > analysis.id

Table theme_variable_group_link {
  theme_id   int [not null]
  group_id   int [not null]
  created_at timestamptz [not null, default: `now()`]
  created_by int [not null]
  Indexes {
    (theme_id, group_id) [pk]
    (group_id, theme_id)
  }
}
Ref: theme_variable_group_link.theme_id    > theme.id [delete: cascade, update: cascade]
Ref: theme_variable_group_link.group_id    > variable_group.id [delete: cascade, update: cascade]
Ref: theme_variable_group_link.created_by  > developer.id

Table geometry {
  id                    uuid   [pk, default: `gen_random_uuid()`]
  name                  text
  geometry_type_id      int    [not null]
  geom                  geometry
  geometries_version_id int   [not null]
  created_at            timestamptz [not null, default: `now()`]
  created_by            int      [not null]
  updated_at            timestamptz [not null, default: `now()`]
  updated_by            int      [not null]
  Indexes {
    (geom)
  }
}
Ref: geometry.geometry_type_id       > geometry_type.id
Ref: geometry.geometries_version_id  > version.id
Ref: geometry.created_by             > developer.id
Ref: geometry.updated_by             > developer.id

Table geometry_lookup {
  id             uuid   [pk, default: `gen_random_uuid()`]
  geometry_id    uuid   [not null]
  variable_id    uuid   [not null]
  attribute_name text
  value          numeric
  Indexes {
    (geometry_id)
    (variable_id)
  }
}
Ref: geometry_lookup.geometry_id > geometry.id [delete: cascade, update: cascade]
Ref: geometry_lookup.variable_id > variable.id [delete: restrict, update: cascade]

Table node {
  id               uuid [pk, default: `gen_random_uuid()`]
  name             text
  geometry_type_id int
  geom             geometry [not null]
  Indexes {
    (geom)
  }
}
Ref: node.geometry_type_id > geometry_type.id

Table arc {
  id               uuid [pk, default: `gen_random_uuid()`]
  from_node_id     uuid [not null, ref: > node.id]
  to_node_id       uuid [not null, ref: > node.id]
  geometry_type_id int
  geom             geometry [not null]
  metadata         json
  Indexes {
    (from_node_id)
    (to_node_id)
    (geom)
  }
}
Ref: arc.geometry_type_id > geometry_type.id

Table geometry_attributes_node {
  id           uuid   [pk, default: `gen_random_uuid()`]
  geometry_id  uuid   [not null]
  sub_type     text
  region_id    int
  shape_length numeric
  Indexes {
    (geometry_id) [unique]
  }
}
Ref: geometry_attributes_node.geometry_id > geometry.id [delete: cascade, update: restrict]
Ref: geometry_attributes_node.region_id > region.id

Table geometry_attributes_arc {
  id              uuid   [pk, default: `gen_random_uuid()`]
  geometry_id     uuid   [not null]
  arc_description text
  from_node       text
  to_node         text
  shape_length    numeric
  Indexes {
    (geometry_id) [unique]
  }
}
Ref: geometry_attributes_arc.geometry_id > geometry.id [delete: cascade, update: restrict]

Table geometry_attributes_demand_unit {
  id          uuid   [pk, default: `gen_random_uuid()`]
  geometry_id uuid   [not null]
  crop_type   text
  region_id   int
  area_ha     numeric
  Indexes {
    (geometry_id) [unique]
  }
}
Ref: geometry_attributes_demand_unit.geometry_id > geometry.id [delete: cascade, update: restrict]
Ref: geometry_attributes_demand_unit.region_id > region.id

Table constant {
  id                  uuid   [pk, default: `gen_random_uuid()`]
  label               text
  year                int
  value               text
  source              text
  metadata_version_id int    [not null]
  Indexes {
    (label, year) [unique]
  }
}
Ref: constant.metadata_version_id > version.id

Table scenario_outcome_value {
  scenario_id        int  [not null, ref: > scenario.id]
  outcome_measure_id int  [not null, ref: > outcome_measure.id]
  geometry_id        uuid [ref: > geometry.id]
  time_period        text
  statistic_type_id  int  [not null, ref: > statistic_type.id]
  value              numeric [not null]
  created_at         timestamptz [not null, default: `now()`]
  Indexes {
    (scenario_id, outcome_measure_id, geometry_id, time_period, statistic_type_id) [unique]
  }
}

Table scenario_tier_value {
  id                 bigserial [pk]
  scenario_id        int  [not null, ref: > scenario.id]
  outcome_measure_id int  [ref: > outcome_measure.id]
  variable_id        uuid
  tier_id            int   [not null, ref: > tier_definition.id]
  level              int   [not null]
  geometry_id        uuid  [ref: > geometry.id]
  time_period        text  [not null]
  source_version_id  int   [not null, ref: > version.id]
  created_by         int   [not null, ref: > developer.id]
  created_at         timestamptz [not null, default: `now()`]
  updated_at         timestamptz
}

Table scenario_outcome_delta {
  id                   int   [pk, increment]
  scenario_id          int  [not null, ref: > scenario.id]
  baseline_scenario_id int  [not null, ref: > scenario.id]
  outcome_measure_id   int  [not null, ref: > outcome_measure.id]
  stat                 text
  value                numeric
  analysis_type_id     int
  rationale            text
  significance_flag    boolean
  created_at           timestamptz [not null, default: `now()`]
  Indexes {
    (scenario_id, outcome_measure_id, stat) [unique]
    (analysis_type_id)
  }
}
Ref: scenario_outcome_delta.analysis_type_id > analysis_type.id

Table analysis_result_delta {
  analysis_id int [not null]
  delta_id    int [not null]
  Indexes {
    (analysis_id, delta_id) [pk]
  }
}
Ref: analysis_result_delta.analysis_id > analysis.id [delete: cascade, update: cascade]
Ref: analysis_result_delta.delta_id > scenario_outcome_delta.id [delete: cascade, update: cascade]

Table network_integration_status {
  id         int  [pk, increment]
  short_code text [not null, unique]
  label      text
}



// NETWORK TOPOLOGY SCHEMA
// 
// Documentation:
// - XML-first approach using CS3_NetworkSchematic_Integrated_11.28.23.xml as authoritative source
// - Dual short_code storage (xml_short_code + geopackage_short_code) for complete traceability
// - Supports 1:many relationships (e.g., WTP nodes connecting to multiple XML diversions)
// - Fuzzy matching with full audit trails and confidence scoring
// - Enhanced source tracking with arrays supporting multiple data sources
// - Systematic manual review process with categorized priorities
// - Physical vs logical node classification
// - Comprehensive data quality and verification framework
//
// Implementation:
// 1. Deployed verified matches (184 records with high confidence)
// 2. Manual review completed (336 items processed with 98% success rate)  
// 3. Demand units reconciled (123/125 found in XML with additional naming)
// 4. Connectivity patterns implemented (D_, I_, R_ arcs, C_ channel handling)
// 5. XML-only logical nodes integrated (6,187 logical network elements)
// 6. WTP one-to-many relationships mapped (37 WTP connections)
// 7. Comprehensive seed table created (6,778 total network elements)
// 8. Full audit trails and connectivity tracking implemented


// Manual review audit table

// Onetomany relationship tracking table 
// Handles cases like WTP connections where one geopackage element maps to multiple XML elements

// REFERENCES
Ref: network_topology.hydrologic_region_id > hydrologic_region.id [delete: restrict, update: cascade]
Ref: network_topology.primary_source_id > source.id [delete: restrict, update: cascade]
Ref: network_topology.network_version_id > version.id [delete: restrict, update: cascade]
Ref: network_topology.schematic_type > calsim_schematic_type.label [delete: restrict, update: cascade]





Table reservoir_entity {
  id                   int    [pk, increment]
  network_node_id      int    [not null, unique, note: "Links to network_node.id (node entities)"]
  short_code           text   [not null, unique]
  name                 text   [not null]
  description          text
  associated_river     text
  entity_type_id       int    [not null]
  schematic_type_id    int    [not null]
  hydrologic_region_id int
  capacity_taf         numeric
  dead_pool_taf        numeric
  surface_area_acres   numeric
  operational_purpose  text
  has_gis_data         boolean [default: false]
  has_tiers            boolean [not null, default: false]
  is_main              boolean [not null, default: false]
  entity_version_id    int    [not null]
  source_ids           int[]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  Indexes {
    (network_node_id) [unique]
    (short_code) [unique]
    (entity_version_id, short_code) [unique]
    (hydrologic_region_id)
    (hydrologic_region_id, entity_type_id)
    (has_gis_data)
    (has_tiers)
    (is_main)
    (associated_river)
    (operational_purpose)
    (entity_version_id)
  }
}
Ref: reservoir_entity.network_node_id      > network_node.id [delete: restrict, update: cascade]
Ref: reservoir_entity.entity_type_id       > calsim_entity_type.id
Ref: reservoir_entity.schematic_type_id    > calsim_schematic_type.id
Ref: reservoir_entity.hydrologic_region_id > hydrologic_region.id
Ref: reservoir_entity.entity_version_id    > version.id
Ref: reservoir_entity.created_by           > developer.id
Ref: reservoir_entity.updated_by           > developer.id

Table reservoir_entity_source_link {
  reservoir_entity_id int [not null]
  source_id           int [not null]
  Indexes {
    (reservoir_entity_id, source_id) [pk]
  }
}
Ref: reservoir_entity_source_link.reservoir_entity_id > reservoir_entity.id [delete: cascade, update: cascade]
Ref: reservoir_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

Table inflow_entity {
  id                   int    [pk, increment]
  network_node_id      int    [not null, unique, note: "Links to network_node.id (node entities)"]
  short_code           text   [not null, unique]
  name                 text   [not null]
  description          text
  to_node              text
  to_node_id           int
  has_gis_data         boolean [default: false]
  entity_type_id       int    [not null]
  schematic_type_id    int    [not null]
  hydrologic_region_id int
  entity_version_id    int    [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  Indexes {
    (network_node_id) [unique]
    (short_code) [unique]
    (entity_version_id, short_code) [unique]
    (to_node)
    (hydrologic_region_id)
    (has_gis_data)
    (entity_type_id)
    (schematic_type_id)
  }
}
Ref: inflow_entity.network_node_id       > network_node.id [delete: restrict, update: cascade]
Ref: inflow_entity.entity_type_id       > calsim_entity_type.id
Ref: inflow_entity.schematic_type_id    > calsim_schematic_type.id
Ref: inflow_entity.hydrologic_region_id > hydrologic_region.id
Ref: inflow_entity.entity_version_id    > version.id
Ref: inflow_entity.created_by           > developer.id
Ref: inflow_entity.updated_by           > developer.id

Table inflow_entity_source_link {
  inflow_entity_id int [not null]
  source_id        int [not null]
  Indexes {
    (inflow_entity_id, source_id) [pk]
  }
}
Ref: inflow_entity_source_link.inflow_entity_id > inflow_entity.id [delete: cascade, update: cascade]
Ref: inflow_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

Table channel_entity {
  id                   int    [pk, increment]
  network_arc_id       int    [not null, unique, note: "Links to network_arc.id (arc entities)"]
  short_code           text   [not null, unique]
  name                 text   [not null]
  description          text
  subtype              text
  boundary_condition   text
  from_node            text
  to_node              text
  from_node_id         int
  to_node_id           int
  length_m             numeric
  has_tiers            boolean [not null, default: false]
  is_main              boolean [not null, default: false]
  has_gis_data         boolean [default: false]
  naming_convention    text
  naming_prefix        text
  entity_type_id       int    [not null]
  schematic_type_id    int    [not null]
  hydrologic_region_id int
  entity_version_id    int    [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  Indexes {
    (network_arc_id) [unique]
    (short_code) [unique]
    (entity_version_id, short_code) [unique]
    (entity_type_id)
    (schematic_type_id)
    (hydrologic_region_id)
    (naming_prefix)
    (has_gis_data)
    (subtype)
    (from_node)
    (to_node)
  }
}
Ref: channel_entity.network_arc_id       > network_arc.id [delete: restrict, update: cascade]
Ref: channel_entity.entity_type_id       > calsim_entity_type.id
Ref: channel_entity.schematic_type_id    > calsim_schematic_type.id
Ref: channel_entity.hydrologic_region_id > hydrologic_region.id
Ref: channel_entity.entity_version_id    > version.id
Ref: channel_entity.created_by           > developer.id
Ref: channel_entity.updated_by           > developer.id

Table channel_entity_source_link {
  channel_entity_id int [not null]
  source_id         int [not null]
  Indexes {
    (channel_entity_id, source_id) [pk]
  }
}
Ref: channel_entity_source_link.channel_entity_id > channel_entity.id [delete: cascade, update: cascade]
Ref: channel_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

// ===========================
// AGRICULTURE DEMAND UNITS
// ===========================

Table du_agriculture_entity {
  id                   int    [pk, increment]
  du_id                text   [not null, unique]
  wba_id               text
  hydrologic_region_id int
  dups                 text
  du_class             text   [not null, default: 'Agriculture']
  cs3_type             text
  total_acres          numeric
  polygon_count        int    [not null, default: 1]
  
  // Agriculture-specific CalSim report data
  agency               text
  provider             text
  gw                   text
  sw                   text
  point_of_diversion   text
  diversion_arc        text
  river_reach          text
  river_mile_start     numeric
  river_mile_end       numeric
  bank                 text
  area_acres           numeric
  annual_diversion_taf numeric
  demand_unit          text
  table_id             text
  
  // Standard entity fields
  entity_type_id       int    [not null]
  schematic_type_id    int    [not null]
  has_gis_data         boolean [default: true]
  has_tiers            boolean [not null, default: false]
  is_main              boolean [not null, default: false]
  
  // Versioning and metadata
  entity_version_id    int    [not null]
  source_ids           int[]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  
  Indexes {
    (du_id) [unique]
    (entity_version_id, du_id) [unique]
    (hydrologic_region_id)
    (hydrologic_region_id, entity_type_id)
    (du_class)
    (cs3_type)
    (agency)
    (provider)
    (diversion_arc)
    (river_reach)
    (total_acres)
    (polygon_count)
  }
}

Ref: du_agriculture_entity.entity_type_id       > calsim_entity_type.id
Ref: du_agriculture_entity.schematic_type_id    > calsim_schematic_type.id
Ref: du_agriculture_entity.hydrologic_region_id > hydrologic_region.id
Ref: du_agriculture_entity.entity_version_id    > version.id
Ref: du_agriculture_entity.created_by           > developer.id
Ref: du_agriculture_entity.updated_by           > developer.id

Table du_agriculture_entity_source_link {
  du_agriculture_entity_id int [not null]
  source_id                int [not null]
  Indexes {
    (du_agriculture_entity_id, source_id) [pk]
  }
}
Ref: du_agriculture_entity_source_link.du_agriculture_entity_id > du_agriculture_entity.id [delete: cascade, update: cascade]
Ref: du_agriculture_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

Table du_agriculture_geometry {
  id                   int    [pk, increment]
  polygon_code         text   [not null, unique]
  du_agriculture_id    int    [not null]
  polygon_sequence     int    [not null]
  
  // Polygon attributes from geopackage
  polygon_type         text
  water_district       text
  urban_name           text
  model_name           text
  sub_name             text
  comments             text
  join_id              text
  acres_wd             numeric
  
  // Spatial data
  geom                 geometry(MULTIPOLYGON, 4326)
  gis_acres            numeric
  shape_length         numeric
  shape_area           numeric
  
  // Versioning and metadata
  geometry_version_id  int    [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  
  Indexes {
    (polygon_code) [unique]
    (du_agriculture_id, polygon_sequence) [unique]
    (du_agriculture_id)
    (polygon_type)
    (water_district)
    (geom) [type: gist]
    (gis_acres)
    (geometry_version_id)
  }
}

Ref: du_agriculture_geometry.du_agriculture_id  > du_agriculture_entity.id [delete: cascade, update: cascade]
Ref: du_agriculture_geometry.geometry_version_id > version.id
Ref: du_agriculture_geometry.created_by          > developer.id
Ref: du_agriculture_geometry.updated_by          > developer.id

// ===========================
// URBAN DEMAND UNITS
// ===========================

Table du_urban_entity {
  id                   int    [pk, increment]
  du_id                text   [not null, unique]
  wba_id               text
  hydrologic_region_id int
  dups                 text
  du_class             text   [not null, default: 'Urban']
  cs3_type             text
  total_acres          numeric
  polygon_count        int    [not null, default: 1]
  
  // Urban-specific CalSim report data
  community_agency     text
  gw                   text
  sw                   text
  point_of_diversion   text
  
  // Standard entity fields
  entity_type_id       int    [not null]
  schematic_type_id    int    [not null]
  has_gis_data         boolean [default: true]
  has_tiers            boolean [not null, default: false]
  is_main              boolean [not null, default: false]
  
  // Versioning and metadata
  entity_version_id    int    [not null]
  source_ids           int[]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  
  Indexes {
    (du_id) [unique]
    (entity_version_id, du_id) [unique]
    (hydrologic_region_id)
    (hydrologic_region_id, entity_type_id)
    (du_class)
    (cs3_type)
    (community_agency)
    (total_acres)
    (polygon_count)
  }
}

Ref: du_urban_entity.entity_type_id       > calsim_entity_type.id
Ref: du_urban_entity.schematic_type_id    > calsim_schematic_type.id
Ref: du_urban_entity.hydrologic_region_id > hydrologic_region.id
Ref: du_urban_entity.entity_version_id    > version.id
Ref: du_urban_entity.created_by           > developer.id
Ref: du_urban_entity.updated_by           > developer.id

Table du_urban_entity_source_link {
  du_urban_entity_id int [not null]
  source_id          int [not null]
  Indexes {
    (du_urban_entity_id, source_id) [pk]
  }
}
Ref: du_urban_entity_source_link.du_urban_entity_id > du_urban_entity.id [delete: cascade, update: cascade]
Ref: du_urban_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

Table du_urban_geometry {
  id                   int    [pk, increment]
  polygon_code         text   [not null, unique]
  du_urban_id          int    [not null]
  polygon_sequence     int    [not null]
  
  // Polygon attributes from geopackage
  polygon_type         text
  water_district       text
  urban_name           text
  model_name           text
  sub_name             text
  comments             text
  join_id              text
  acres_wd             numeric
  
  // Spatial data
  geom                 geometry(MULTIPOLYGON, 4326)
  gis_acres            numeric
  shape_length         numeric
  shape_area           numeric
  
  // Versioning and metadata
  geometry_version_id  int    [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  
  Indexes {
    (polygon_code) [unique]
    (du_urban_id, polygon_sequence) [unique]
    (du_urban_id)
    (polygon_type)
    (water_district)
    (geom) [type: gist]
    (gis_acres)
    (geometry_version_id)
  }
}

Ref: du_urban_geometry.du_urban_id          > du_urban_entity.id [delete: cascade, update: cascade]
Ref: du_urban_geometry.geometry_version_id  > version.id
Ref: du_urban_geometry.created_by           > developer.id
Ref: du_urban_geometry.updated_by           > developer.id

// ===========================
// REFUGE DEMAND UNITS
// ===========================

Table du_refuge_entity {
  id                   int    [pk, increment]
  du_id                text   [not null, unique]
  wba_id               text
  hydrologic_region_id int
  dups                 text
  du_class             text   [not null, default: 'Refuge']
  cs3_type             text
  total_acres          numeric
  polygon_count        int    [not null, default: 1]
  
  // Refuge-specific CalSim report data
  refuge_or_wildlife_area        text
  managed_by                     text
  provider                       text
  gw                             text
  sw                             text
  point_of_diversion_conveyance  text
  
  // Standard entity fields
  entity_type_id       int    [not null]
  schematic_type_id    int    [not null]
  has_gis_data         boolean [default: true]
  has_tiers            boolean [not null, default: false]
  is_main              boolean [not null, default: false]
  
  // Versioning and metadata
  entity_version_id    int    [not null]
  source_ids           int[]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  
  Indexes {
    (du_id) [unique]
    (entity_version_id, du_id) [unique]
    (hydrologic_region_id)
    (hydrologic_region_id, entity_type_id)
    (du_class)
    (cs3_type)
    (refuge_or_wildlife_area)
    (managed_by)
    (provider)
    (total_acres)
    (polygon_count)
  }
}

Ref: du_refuge_entity.entity_type_id       > calsim_entity_type.id
Ref: du_refuge_entity.schematic_type_id    > calsim_schematic_type.id
Ref: du_refuge_entity.hydrologic_region_id > hydrologic_region.id
Ref: du_refuge_entity.entity_version_id    > version.id
Ref: du_refuge_entity.created_by           > developer.id
Ref: du_refuge_entity.updated_by           > developer.id

Table du_refuge_entity_source_link {
  du_refuge_entity_id int [not null]
  source_id           int [not null]
  Indexes {
    (du_refuge_entity_id, source_id) [pk]
  }
}
Ref: du_refuge_entity_source_link.du_refuge_entity_id > du_refuge_entity.id [delete: cascade, update: cascade]
Ref: du_refuge_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

Table du_refuge_geometry {
  id                   int    [pk, increment]
  polygon_code         text   [not null, unique]
  du_refuge_id         int    [not null]
  polygon_sequence     int    [not null]
  
  // Polygon attributes from geopackage
  polygon_type         text
  water_district       text
  urban_name           text
  model_name           text
  sub_name             text
  comments             text
  join_id              text
  acres_wd             numeric
  
  // Spatial data
  geom                 geometry(MULTIPOLYGON, 4326)
  gis_acres            numeric
  shape_length         numeric
  shape_area           numeric
  
  // Versioning and metadata
  geometry_version_id  int    [not null]
  created_at           timestamptz [not null, default: `now()`]
  created_by           int    [not null]
  updated_at           timestamptz [not null, default: `now()`]
  updated_by           int
  
  Indexes {
    (polygon_code) [unique]
    (du_refuge_id, polygon_sequence) [unique]
    (du_refuge_id)
    (polygon_type)
    (water_district)
    (geom) [type: gist]
    (gis_acres)
    (geometry_version_id)
  }
}

Ref: du_refuge_geometry.du_refuge_id         > du_refuge_entity.id [delete: cascade, update: cascade]
Ref: du_refuge_geometry.geometry_version_id  > version.id
Ref: du_refuge_geometry.created_by           > developer.id
Ref: du_refuge_geometry.updated_by           > developer.id

// ===========================
// DIVERSION ARC ENTITIES
// ===========================

Table diversion_arc_entity {
  id                     int    [pk, increment]
  short_code             text   [not null, unique]
  name                   text   [not null]
  
  // River location data
  river_reach            text
  river_mile_start       numeric
  river_mile_end         numeric
  bank                   text
  area_acres             numeric
  annual_diversion_taf   numeric
  
  // Network connectivity (direct node FKs - nullable for missing nodes)
  from_node_id           int
  to_node_id             int
  
  // Standard entity fields
  entity_type_id         int    [not null, default: 2] // channel entity type
  schematic_type_id      int    [not null, default: 1] // main schematic
  hydrologic_region_id   int    [not null, default: 1] // SAC region
  has_gis_data           boolean [default: false]
  has_tiers              boolean [not null, default: false]
  is_main                boolean [not null, default: false]
  
  // Versioning and metadata
  entity_version_id      int    [not null]
  source_ids             int[]
  created_at             timestamptz [not null, default: `now()`]
  created_by             int    [not null]
  updated_at             timestamptz [not null, default: `now()`]
  updated_by             int
  
  Indexes {
    (short_code) [unique]
    (entity_version_id, short_code) [unique]
    (from_node_id)
    (to_node_id)
    (from_node_id, to_node_id)
    (hydrologic_region_id)
    (annual_diversion_taf)
  }
}

Ref: diversion_arc_entity.entity_type_id         > calsim_entity_type.id
Ref: diversion_arc_entity.schematic_type_id      > calsim_schematic_type.id
Ref: diversion_arc_entity.hydrologic_region_id   > hydrologic_region.id
Ref: diversion_arc_entity.entity_version_id      > version.id
Ref: diversion_arc_entity.created_by             > developer.id
Ref: diversion_arc_entity.updated_by             > developer.id

Table diversion_arc_entity_source_link {
  diversion_arc_entity_id int [not null]
  source_id               int [not null]
  Indexes {
    (diversion_arc_entity_id, source_id) [pk]
  }
}
Ref: diversion_arc_entity_source_link.diversion_arc_entity_id > diversion_arc_entity.id [delete: cascade, update: cascade]
Ref: diversion_arc_entity_source_link.source_id > source.id [delete: restrict, update: cascade]

Table reservoir_variable {
  id                          int    [pk, increment]
  calsim_id                   text   [not null, unique]
  name                        text   [not null]
  description                 text
  reservoir_entity_id         int    [not null]
  primary_entity_short_code   text
  variable_type               text   [not null]
  storage_zone_type           text
  operational_purpose         text
  is_aggregate                boolean [default: false]
  trigger_threshold           numeric
  unit_id                     int
  temporal_scale_id           int
  variable_id                 uuid   [not null, unique]
  variable_version_id         int    [not null]
  created_at                  timestamptz [not null, default: `now()`]
  created_by                  int [not null]
  updated_at                  timestamptz [not null, default: `now()`]
  updated_by                  int
  Indexes {
    (reservoir_entity_id)
    (variable_type)
    (storage_zone_type)
    (operational_purpose)
    (is_aggregate)
  }
}
Ref: reservoir_variable.reservoir_entity_id > reservoir_entity.id     [delete: cascade, update: cascade]
Ref: reservoir_variable.unit_id             > unit.id                 [delete: restrict, update: cascade]
Ref: reservoir_variable.temporal_scale_id   > temporal_scale.id    [delete: restrict, update: cascade]
Ref: reservoir_variable.variable_version_id > version.id                 [delete: restrict, update: cascade]
Ref: reservoir_variable.created_by          > developer.id          [delete: restrict, update: cascade]
Ref: reservoir_variable.updated_by          > developer.id          [delete: restrict, update: cascade]
Ref: reservoir_variable.variable_id         > variable.id          [delete: restrict, update: cascade]

Table inflow_variable {
  id                       int    [pk, increment]
  calsim_id                text   [not null, unique]
  name                     text   [not null]
  description              text
  inflow_entity_id         int    [not null]
  variable_type            text   [not null]
  unit_id                  int
  temporal_scale_id        int
  variable_id              uuid   [not null, unique]
  variable_version_id      int    [not null]
  is_aggregate             boolean [default: false]
  created_at               timestamptz [not null, default: `now()`]
  created_by               int    [not null]
  updated_at               timestamptz [not null, default: `now()`]
  updated_by               int
  Indexes {
    (inflow_entity_id)
    (variable_type)
    (is_aggregate)
  }
}
Ref: inflow_variable.inflow_entity_id       > inflow_entity.id     [delete: cascade, update: cascade]
Ref: inflow_variable.unit_id                > unit.id              [delete: restrict, update: cascade]
Ref: inflow_variable.temporal_scale_id      > temporal_scale.id    [delete: restrict, update: cascade]
Ref: inflow_variable.variable_version_id    > version.id              [delete: restrict, update: cascade]
Ref: inflow_variable.created_by             > developer.id          [delete: restrict, update: cascade]
Ref: inflow_variable.updated_by             > developer.id          [delete: restrict, update: cascade]
Ref: inflow_variable.variable_id            > variable.id          [delete: restrict, update: cascade]

Table channel_variable {
  id                          int    [pk, increment]
  calsim_id                   text   [not null, unique]
  name                        text   [not null]
  description                 text
  channel_entity_id           int    [not null]
  variable_type               text   [not null]
  unit_id                     int
  temporal_scale_id           int
  variable_id                 uuid   [not null, unique]
  variable_version_id         int    [not null]
  is_regulatory               boolean [default: false]
  regulatory_authority        text
  is_aggregate                boolean [default: false]
  outcome_category_short_code text
  created_at                  timestamptz [not null, default: `now()`]
  created_by                  int    [not null]
  updated_at                  timestamptz [not null, default: `now()`]
  updated_by                  int
  Indexes {
    (channel_entity_id)
    (variable_type)
    (is_regulatory)
    (is_aggregate)
  }
}
Ref: channel_variable.channel_entity_id > channel_entity.id    [delete: cascade, update: cascade]
Ref: channel_variable.unit_id               > unit.id              [delete: restrict, update: cascade]
Ref: channel_variable.temporal_scale_id     > temporal_scale.id    [delete: restrict, update: cascade]
Ref: channel_variable.variable_version_id   > version.id              [delete: restrict, update: cascade]
Ref: channel_variable.created_by            > developer.id          [delete: restrict, update: cascade]
Ref: channel_variable.updated_by            > developer.id          [delete: restrict, update: cascade]
Ref: channel_variable.variable_id           > variable.id          [delete: restrict, update: cascade]

Table derived_variable_type {
  id          int  [pk, increment]
  short_code  text [not null, unique]
  name        text [not null]
  description text
  is_active   boolean [not null, default: true]
  created_at  timestamptz [not null, default: `now()`]
  created_by  int      [not null]
  updated_at  timestamptz
  updated_by  int
  Indexes {
    (short_code) [unique]
    (is_active, short_code)
  }
}
Ref: derived_variable_type.created_by > developer.id
Ref: derived_variable_type.updated_by > developer.id

Table derived_variable {
  id                          int    [pk, increment]
  calsim_id                   text   [not null, unique]
  name                        text   [not null]
  description                 text
  variable_type_id            int    [not null]
  system_scope                text
  calculation_method          text
  hydrologic_region_id        int
  spatial_description         text
  unit_id                     int
  temporal_scale_id           int
  variable_id                 uuid   [not null, unique]
  variable_version_id         int    [not null]
  is_aggregate                boolean [default: false]
  aggregation_rule            text
  is_regulatory               boolean [default: false]
  regulatory_authority        text
  regulatory_threshold        numeric
  outcome_category_short_code text
  created_at                  timestamptz [not null, default: `now()`]
  created_by                  int    [not null]
  updated_at                  timestamptz [not null, default: `now()`]
  updated_by                  int
  Indexes {
    (variable_type_id)
    (system_scope)
    (hydrologic_region_id)
    (is_regulatory)
    (is_aggregate)
    (outcome_category_short_code)
  }
}
Ref: derived_variable.variable_type_id     > derived_variable_type.id
Ref: derived_variable.hydrologic_region_id > hydrologic_region.id
Ref: derived_variable.unit_id              > unit.id
Ref: derived_variable.temporal_scale_id    > temporal_scale.id
Ref: derived_variable.variable_version_id  > version.id
Ref: derived_variable.created_by           > developer.id
Ref: derived_variable.updated_by           > developer.id
Ref: derived_variable.variable_id          > variable.id

Table theme_network_region_link {
  theme_id             int [not null]
  hydrologic_region_id int [not null]
  focus_description    text
  created_at           timestamptz [not null, default: `now()`]
  created_by           int [not null]
  Indexes {
    (theme_id, hydrologic_region_id) [pk]
    (hydrologic_region_id, theme_id)
  }
}
Ref: theme_network_region_link.theme_id            > theme.id             [delete: cascade, update: cascade]
Ref: theme_network_region_link.hydrologic_region_id > hydrologic_region.id
Ref: theme_network_region_link.created_by          > developer.id

Table theme_entity_type_focus {
  theme_id           int  [not null]
  entity_type_id     int  [not null]
  focus_description  text
  focus_weight       numeric [default: 1.0]
  created_at         timestamptz [not null, default: `now()`]
  created_by         int [not null]
  Indexes {
    (theme_id, entity_type_id) [pk]
  }
}
Ref: theme_entity_type_focus.theme_id > theme.id
Ref: theme_entity_type_focus.entity_type_id > calsim_entity_type.id
Ref: theme_entity_type_focus.created_by > developer.id
